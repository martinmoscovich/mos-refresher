angular.module("mos.mobile.components",[]).constant("MOS_REFRESHER_CONFIG",{defaults:{distance:60,overflow:80,resistance:2.5,startPos:70},hidingTime:300}).directive("mosRefresher",["$ionicGesture","$timeout","MOS_REFRESHER_CONFIG",function(e,n,t){return{restrict:"E",template:"<div ng-transclude></div>",require:"?^$ionicScroll",transclude:!0,scope:{onRefresh:"&",onDragStart:"&",onDrag:"&",onRelease:"&",onRefreshChange:"&",onHiding:"&",onFinish:"&"},controller:["$scope",function(e){this.addListener=function(n){e.listener=n}}],link:function(s,r,o,a){function i(e,n){if(s.listener&&s.listener[e]){var t=new Event(e,{cancelable:!0});t.params=n;var r=s.listener[e].apply(s.listener,[t]);if(t.defaultPrevented)return r}return s[e]?s[e].apply(s,[n]):void 0}function l(e){if("ion-content"===e[0].localName)return e;var n=e.parent();return n?l(n):null}function c(){S&&(s.listener=null,A&&n.cancel(A),e.off(S.start,"dragstart",u),e.off(S.down,"dragdown",v),e.off(S.end,"dragend",g),x.off("scroll",p),r.off("transitionend",h),r.off("$destroy",c))}function d(){if(x=l(r),!x)throw new Error("Refresher must be a child of ion-content");var n=/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor);n&&r.css("position","fixed"),T=angular.element(r[0].querySelector(".mos-rotate")),r.on("$destroy",c),S={start:e.on("dragstart",u,x),down:e.on("dragdown",v,x),end:e.on("dragend",g,x),transitionEnd:r.on("transitionend",h)},f()}function f(){r.children().addClass("mos-content"),r.addClass("mos-hidden"),C()}function h(e){r.hasClass("mos-hiding")&&(e&&A&&n.cancel(A),m(r,""),r.addClass("mos-hidden"),r.removeClass("mos-hiding mos-refreshed"),i("onFinish")),r.hasClass("mos-will-refresh")&&r.removeClass("mos-will-refresh")}function m(e,n){e.css({"-webkit-transform":n,"-moz-transform":n,"-ms-transform":n,transform:n})}function u(){if(y.enabled){var e=a?a.getScrollPosition().top:x[0].scrollTop;e<=F.maxStartY&&(b=a?0:e,0===T.length&&(T=angular.element(r[0].querySelector(".mos-rotate"))),y.active=!0,y.enabled=!1,r.removeClass("mos-hidden"),r.addClass("mos-dragging"),i("onDragStart"),M=r[0].offsetHeight,w(0))}}function g(e){y.active&&(e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),y.active=!1,r.removeClass("mos-dragging"),m(T,""),i("onRelease"),M=r[0].offsetHeight,y.mustRefresh?R():C(!1))}function v(e){if(y.active){e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),y.distance=e.gesture.distance/F.resistance;var n=100*y.distance/F.distanceToRefresh;y.distance<=F.distanceToRefresh+F.extraDistance&&(w(y.distance),m(T,"rotate("+3.6*n+"deg)"),i("onDrag",{distance:y.distance,percentage:n})),y.distance>F.distanceToRefresh?y.mustRefresh||(r.addClass("mos-refresh"),y.mustRefresh=!0,i("onRefreshChange",{willRefresh:!0})):y.mustRefresh&&(r.removeClass("mos-refresh"),y.mustRefresh=!1,i("onRefreshChange",{willRefresh:!1}))}}function p(e){b=e.target.scrollTop,w(F.distanceToRefresh)}function R(){r.addClass("mos-refreshing mos-will-refresh"),x.on("scroll",p),w(F.distanceToRefresh);var e=i("onRefresh");e&&e.then&&e.then(function(){x.off("scroll",p),C(!0)})}function C(e){s.loading=!1,y={active:!1,distance:0,mustRefresh:!1,enabled:!0},r.removeClass("mos-refresh mos-refreshing mos-dragging"),r.hasClass("mos-hidden")||(e&&r.addClass("mos-refreshed"),r.addClass("mos-hiding"),A=n(h,t.hidingTime),i("onHiding")),e?w(F.distanceToRefresh,"scale(0.1)"):w(0)}function w(e,n){var t=r[0].offsetHeight;0===t&&(t=M),m(r,"translate3d( 0, "+(e+b-M-2)+"px, 0 )"+(n?" "+n:""))}var x,T,y,S,M,A,P=t.defaults,b=0,F={distanceToRefresh:parseInt(o.distance)||P.distance,overflow:parseInt(o.overflow)||P.overflow,resistance:parseFloat(o.resistance)||P.resistance,maxStartY:parseInt(o.startPos)||P.startPos};F.extraDistance=F.distanceToRefresh*F.overflow/100,d()}}}]),angular.module("mos.mobile.components").directive("mosAnimatedArrow",["$interval",function(e){return{restrict:"A",require:["mosRefresher","mosAnimatedArrow"],controller:["$scope","$element",function(n,t){function s(e,n,t,s){return[e+Math.cos(s)*t,n+Math.sin(s)*t]}var r;this.onDrag=function(e){100*(e.params.percentage/100*80-70)/10;d(e.params.percentage/100)},this.onRefresh=function(){r=e(function(){h()},15)},this.onHiding=function(){r&&e.cancel(r)};var o,a;this.init=function(e){e.addListener(this),o=t.find("canvas")[0],a=o.getContext("2d")};var i,l=2*Math.PI,c=Math.PI/2,d=function(e){var n={x:o.width/2,y:o.height/2};a.translate(n.x,n.y),a.rotate(Math.PI/2*(e-i)),a.translate(-n.x,-n.y),a.clearRect(0,0,o.width,o.height),f(o,Math.min(e,1),n,o.width/2),i=e},f=function(e,n,t,r){var o=.75*n,i=l*o-c,d=s(t.x,t.y,.5*r,i);a.beginPath(),a.arc(t.x,t.y,r-1,0,l,!1),a.strokeStyle="#CACACA",a.fillStyle="#FFFFFF",a.stroke(),a.fill(),a.beginPath(),a.fillStyle=a.strokeStyle=1>n?"rgba(100,100,100,1)":"#99CC33";var f=10;a.lineWidth=f,a.arc(t.x,t.y,.5*r,-c,i,!1),a.stroke(),a.beginPath(),a.lineWidth=1;var h=Math.max(5,15*o);a.lineTo(d[0]+Math.cos(i)*h,d[1]+Math.sin(i)*h),a.lineTo(d[0]-Math.cos(i)*h,d[1]-Math.sin(i)*h),a.lineTo(d[0]+Math.cos(i+Math.PI/2)*h,d[1]+Math.sin(i+Math.PI/2)*h),a.lineTo(d[0]+Math.cos(i)*h,d[1]+Math.sin(i)*h),a.fill()},h=function(){var e={x:o.width/2,y:o.height/2};a.translate(e.x,e.y),a.rotate(Math.PI/2*.1),a.translate(-e.x,-e.y),f(o,1,e,o.width/2)}}],link:function(e,n,t,s){var r=n.find("div");r.html("<style>mos-refresher canvas { }</style>"),r.append('<canvas width="50px" height="50px"></canvas>'),s[1].init(s[0])}}}]),angular.module("mos.mobile.components").directive("mosArrow",function(){return{restrict:"A",require:["mosRefresher","mosArrow"],controller:["$scope","$element",function(e,n){var t,s,r;this.init=function(e){e.addListener(this),t=angular.element(n[0].querySelector(".icon")),s=angular.element(n[0].querySelector(".mos-icon")),r=angular.element(n[0].querySelector(".mos-refresher-text"))},this.onRefreshChange=function(n){r.html(n.params.willRefresh?e.releaseText:e.pullText)},this.onRefresh=function(){t.addClass("ion-load-c").removeClass("ion-arrow-down-a"),s.addClass("mos-rotate"),r.html(e.loadingText)},this.onFinish=function(){s.removeClass("mos-rotate"),t.removeClass("ion-load-c").addClass("ion-arrow-down-a"),r.html(e.pullText)},this.onRelease=function(){r.html(e.pullText)}}],link:function(e,n,t,s){var r=n.find("div");e.pullText=t.pullText||"Pull To Refresh",e.releaseText=t.releaseText||"Release To Refresh",e.loadingText=t.loadingText||"Loading";var o=t.iconSize||50;n.addClass("mos-arrow"),r.html('<div class="mos-icon"><i style="font-size: '+o+'px;" class="icon ion-arrow-down-a"></i></div><span class="mos-refresher-text">'+e.pullText+"</span>"),s[1].init(s[0])}}}),angular.module("mos.mobile.components").directive("mosSpinningIcon",function(){return{restrict:"A",require:"mosRefresher",link:function(e,n,t){var s=n.find("div"),r=t.mosSpinningIcon||"ion-ios7-refresh",o=t.iconRefreshColor||"#0D0BA4",a=t.iconSize||"#0D0BA4";n.addClass("mos-spinning-icon"),s.html("<style>mos-refresher.mos-spinning-icon .icon { font-size: "+a+"px; } mos-refresher.mos-spinning-icon.mos-refresh .icon { color: "+o+"; }</style>"),s.append('<div class="mos-rotate"><i class="icon '+r+'"></i></div>')}}});