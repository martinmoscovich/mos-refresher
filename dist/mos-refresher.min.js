angular.module("mos.mobile.components",[]).constant("MOS_REFRESHER_CONFIG",{defaults:{distance:60,overflow:80,resistance:2.5,startPos:70},hidingTime:300}).directive("mosRefresher",["$ionicGesture","$timeout","MOS_REFRESHER_CONFIG",function(e,s,n){return{restrict:"E",template:"<div ng-transclude></div>",require:"?^$ionicScroll",transclude:!0,scope:{onRefresh:"&",onDragStart:"&",onDrag:"&",onRelease:"&",onRefreshChange:"&",onHiding:"&",onFinish:"&"},controller:["$scope",function(e){this.addListener=function(s){e.listener=s}}],link:function(t,r,o,a){function i(e,s){if(t.listener&&t.listener[e]){var n=new Event(e,{cancelable:!0});n.params=s;var r=t.listener[e].apply(t.listener,[n]);if(n.defaultPrevented)return r}return t[e]?t[e].apply(t,[s]):void 0}function l(e){if("ion-content"===e[0].localName)return e;var s=e.parent();return s?l(s):null}function d(){D&&(t.listener=null,F&&s.cancel(F),e.off(D.start,"dragstart",u),e.off(D.down,"dragdown",v),e.off(D.end,"dragend",g),E.off("scroll",R),r.off("transitionend",h),r.off("$destroy",d))}function f(){if(E=l(r),!E)throw new Error("Refresher must be a child of ion-content");var s=/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor);s&&r.css("position","fixed"),S=angular.element(r[0].querySelector(".mos-rotate")),r.on("$destroy",d),D={start:e.on("dragstart",u,E),down:e.on("dragdown",v,E),end:e.on("dragend",g,E),transitionEnd:r.on("transitionend",h)},c()}function c(){r.children().addClass("mos-content"),r.addClass("mos-hidden"),C()}function h(e){r.hasClass("mos-hiding")&&(e&&F&&s.cancel(F),m(r,""),r.addClass("mos-hidden"),r.removeClass("mos-hiding mos-refreshed"),i("onFinish")),r.hasClass("mos-will-refresh")&&r.removeClass("mos-will-refresh")}function m(e,s){e.css({"-webkit-transform":s,"-moz-transform":s,"-ms-transform":s,transform:s})}function u(){if(T.enabled){var e=a?a.getScrollPosition().top:E[0].scrollTop;e<=y.maxStartY&&(x=a?0:e,0===S.length&&(S=angular.element(r[0].querySelector(".mos-rotate"))),T.active=!0,T.enabled=!1,r.removeClass("mos-hidden"),r.addClass("mos-dragging"),i("onDragStart"),b=r[0].offsetHeight,w(0))}}function g(e){T.active&&(e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),T.active=!1,r.removeClass("mos-dragging"),m(S,""),i("onRelease"),b=r[0].offsetHeight,T.mustRefresh?p():C(!1))}function v(e){if(T.active){e.gesture.preventDefault(),e.gesture.srcEvent.preventDefault(),T.distance=e.gesture.distance/y.resistance;var s=100*T.distance/y.distanceToRefresh;T.distance<=y.distanceToRefresh+y.extraDistance&&(w(T.distance),m(S,"rotate("+3.6*s+"deg)"),i("onDrag",{distance:T.distance,percentage:s})),T.distance>y.distanceToRefresh?T.mustRefresh||(r.addClass("mos-refresh"),T.mustRefresh=!0,i("onRefreshChange",{willRefresh:!0})):T.mustRefresh&&(r.removeClass("mos-refresh"),T.mustRefresh=!1,i("onRefreshChange",{willRefresh:!1}))}}function R(e){x=e.target.scrollTop,w(y.distanceToRefresh)}function p(){r.addClass("mos-refreshing mos-will-refresh"),E.on("scroll",R),w(y.distanceToRefresh);var e=i("onRefresh");e&&e.then&&e.then(function(){E.off("scroll",R),C(!0)})}function C(e){t.loading=!1,T={active:!1,distance:0,mustRefresh:!1,enabled:!0},r.removeClass("mos-refresh mos-refreshing mos-dragging"),r.hasClass("mos-hidden")||(e&&r.addClass("mos-refreshed"),r.addClass("mos-hiding"),F=s(h,n.hidingTime),i("onHiding")),e?w(y.distanceToRefresh,"scale(0.1)"):w(0)}function w(e,s){var n=r[0].offsetHeight;0===n&&(n=b),m(r,"translate3d( 0, "+(e+x-b-2)+"px, 0 )"+(s?" "+s:""))}var E,S,T,D,b,F,H=n.defaults,x=0,y={distanceToRefresh:parseInt(o.distance)||H.distance,overflow:parseInt(o.overflow)||H.overflow,resistance:parseFloat(o.resistance)||H.resistance,maxStartY:parseInt(o.startPos)||H.startPos};y.extraDistance=y.distanceToRefresh*y.overflow/100,f()}}}]);